---
title: "Module 8"
author: "Rbots"
date: '2022-11-30'
output: html_document
bibliography: BIOL3140_bibliography
---
# Introduction 
Trans-Gulf migrants are bird species that fly non-stop over the Gulf of Mexico and arrive on land between Texas and Florida. The date when these individuals arrive has important fitness consequences and now need to be shifted in a changing climate. Trans-Gulf migrants must now shift their arrival data at breeding areas in response to warmer spring temperatures or their populations may decline. There has been significant evidence for advanced spring arrival dates in coordination with warmer temperatures at the arrival destination [sparks2007consistent]. Climate change has the potential to further increase temperatures and cause even earlier arrival times. In recent decades, citizen science has become more popularized as public interest in species conservation has also increased. The Cornell Laboratory of Ornithology and the National Audubon Society have established eBird which amateur birders can use to submit their bird observations. This project uses eBird and meteorological data to study the effect of local weather conditions on the arrival time of Trans-Gulf migrants in Massachusetts.

# Methods 
The first thing we had to do for our project was to select 5 different trans-Gulf migrants (TGM). We made sure to pick species which were members of different families of birds. The 5 species we chose were the *Purple Martin* (Progne subis), the *Scarlet Tanager* (Piranga olivacea), the *Palm Warbler* (Setophaga palmarum), the *Baltimore Oriole* (Icterus galbula), and the *Eastern Kingbird* (Tyrannus tyrannus). The data for these birds and their flight paths were obtained from the eBird database compiled by the Cornell lab of Ornithology. In order to collect the data for our birds, we iterated the 5 species of birds we have through the occ_data() function from rgbif. 

*Methods still needs work, quite a bit is missing*

# Results
```{r, "Loading Libraries"}
library(rgbif)
library(tidyverse)
library(MuMIn)
library(rnoaa)
library(ggmap)
library(usmap)
library(magick)
library(cowplot)
library(lme4)
library(car)
library(rsconnect)
library(curl)
library(data.table)
library(knitr)
library(rgdal)
```

```{r, "Obtaining Specific Bird Data", cache=TRUE} 
#We set this code chunk to cache=TRUE, because the code took a significant amount of time to run, and we wanted to prevent having to run it over and over. Instead, the cache remembers the code unless we make a change!
species <- c("Progne subis","Piranga olivacea","Setophaga palmarum","Icterus galbula","Tyrannus tyrannus")
y <- paste0("2000",",","2019") #In the Additional Operations and Analyses section, we are asked to analyze our species from 2000-2019 
m <- paste0("4",",","5") #In the Additional Operations and Analyses section, we are asked to analyze our species during April and May which correspond to the months 4 and 5 
dat.l <-list()
for(s in species){
n.obs <-  occ_data(scientificName = s,year=y,month=m,limit=0,country="US",basisOfRecord = "HUMAN_OBSERVATION",stateProvince="Massachusetts")$meta$count 
print(n.obs)
dat.l[[paste0(s)]] <- occ_data(scientificName = s,year=y,month=m,
                               limit=n.obs,country="US",
                               basisOfRecord = "HUMAN_OBSERVATION",
                               stateProvince="Massachusetts")[[2]]
}
#This is where the code stopped for Tori last time!
dat <- rbindlist(dat.l,fill=T)
head(dat)
saveRDS(data,"massbird.data.RDS")
```

```{r, "Understanding the Numbers We're Dealing With"}
dat <- readRDS("massbird.data.RDS")
dat%>%
  group_by(year,species)%>%
  summarise(count=sum(individualCount,na.rm = T))%>%
  ggplot(aes(x=year,y=count,col=species))+geom_point()
```

We successfully loaded the species occurrence data in from GBIFâ€™s API, and used this graph to visualize the data we have. The graph above allows us to see the amount of data we have, with the dependency of count of species data on the year in the time range requested (Between April and May in 2000-2019).

```{r, "Loading Weather Station Data", cache=TRUE}
#We set this code chunk to cache=TRUE, because the code took a significant amount of time to run, and we wanted to prevent having to run it over and over. Instead, the cache remembers the code unless we make a change!
options(noaakey = "RrJIqfCapgshUXBCJlyjYvYxZEctURiq")
sts <- c(
  "GHCND:USW00013894", #Mobible, AL 2k away about 10 days away @200 km/day
  "GHCND:USW00013881", #Charlotte, NC 1000 km away about 6 days away @200 km/day
  "GHCND:USW00014739" #Boston
)
sta.d <- bind_rows( #bind the rows
  lapply(sts,function(x) ncdc_stations(stationid = x)$data ) #use lapply to run through stations
  )%>%
  mutate(usmap_transform(.,input_names = c("longitude","latitude"),output_names = c("longitude.1", "latitude.1")))%>% #join transformation of lat/long for projection with usmap
  mutate(name=str_sub(name, -5,-4))%>% #simplify the name column, grab just the state
  mutate(migr.day=c(10,5,0))%>% #so we can look at wind speed 0, 5 or 10 days before arrive in boston
  separate(id,into = c("station.type","id"))%>% #need to cut station type out from station id number
```

```{r, "Graphing Stations"}
plot_usmap(
  include = c(.northeast_region,.south_region,.east_north_central)
)+geom_point(data=sta.d,aes(x=longitude.1,y=latitude.1,col=name),size=5)+geom_label(data=sta.d,aes(x=longitude.1,y=latitude.1,col=name,label=name),size=5,nudge_x = 1e6*0.25)+theme(legend.position = "none")
```

The map above shows the three locations from which we are collecting weather data as a visual representation of the distance between the stations.

```{r, "Obtaining Weather Station Data", cache=TRUE}
#We set this code chunk to cache=TRUE, because the code took a significant amount of time to run, and we wanted to prevent having to run it over and over. Instead, the cache remembers the code unless we make a change!
weather.d <- meteo_pull_monitors(sta.d$id,date_min = "2000-01-01")
```

#Tori stop here!!!!

```{r}
mc<- dat%>%
  filter(species=="Progne subis")%>%
  group_by(year)%>%
  mutate(date=as.Date(paste0(year,"-",month,"-",day)),
         j.day=julian(date,origin=as.Date(paste0(unique(year),"-01-01")))
  )%>%
  group_by(species,year,j.day,date)%>%
  summarise(day.tot=sum(individualCount,na.rm=T))%>%
  group_by(species,year)%>%
  mutate(prop=cumsum(day.tot/sum(day.tot,na.rm = T)))%>%
  filter(year>1999)

mc%>%
  ggplot(aes(j.day,prop))+geom_point()+facet_wrap(year~.)

mc.pred <- mc%>%
  group_by(year)%>%
 summarize(
   pred=predict(nls(prop~SSlogis(j.day,Asym, xmid, scal)),newdata=data.frame(j.day=min(j.day):max(j.day))),#predict the logistic curve for each species
   j.day=min(j.day):max(j.day),
  )%>%
  left_join(mc%>%dplyr::select(j.day,date)) ## add date back to tibble

mc%>%
  ggplot(aes(j.day,prop))+geom_point(aes=0.3)+geom_line(data=mc.pred,aes(x=j.day,y=pred),col="blue",size=2)+facet_wrap(year~.)

mc.arrive.date <-mc.pred%>%
  group_by(year)%>%
  filter(j.day==j.day[which.min(abs(pred-0.25))])

mc.arrive.date%>%
  ggplot(aes(year,j.day))+geom_point()

weather.d <- weather.d%>%
  mutate(year=as.integer(str_sub(date,1,4)), #add year
         date=as.Date(date))%>%
  group_by(year)%>% #group by year so we can compute julian day
 mutate(j.day=julian(date,origin=as.Date(paste0(unique(year),"-01-01"))), #add julian day
  date2=date,
  wdir.rad=(180-abs(wdf2-180))*pi/180, #radians so we can use a trig function to compute wind vector, scale degrees first to 180 scale to 2x pi and subtract from 180 (wind comes out of a direction)
  wvec=cos(wdir.rad)*-1*awnd # we want a negative value for positive value for 2x pi
  )%>% #store day in new column
  dplyr::select(id,year,date2,j.day,tmin,tmax,wvec)%>% #select the rows we need
  left_join(sta.d%>%select(id,name,migr.day))%>% #add the station id info (ie. name)
  mutate(j.day=j.day+migr.day)#make j.day ahead of BOS according to the migration days away so we can join weather along path

mc.arr.weath <- mc.arrive.date%>%
  left_join(weather.d)%>%
  left_join(mc%>%dplyr::select(year,date,j.day))

head(mc.arr.weath)

weather.wk <-weather.d %>% 
  group_by(year,name) %>% 
  mutate(wk.tmin = frollmean(tmin, n=14,align="right"),
         wk.tmax = frollmean(tmax, n=14,align="right"),
         wk.wvec = frollmean(wvec, n=14,align="right")
         )%>%
  dplyr::select(j.day,date2,name,wk.tmin,wk.tmax,wk.wvec)

mc.arr.weath2 <- mc.arrive.date%>%
  left_join(weather.wk)

head(mc.arr.weath2)
```

##Linear Mixed-effect Modeling
```{r}
#weather at 0, 5, and 10 days away from arrival
mc.lmer <- lmer(j.day~tmin*tmax*wvec+(1|name),mc.arr.weath,na.action = "na.fail")

Anova(mc.lmer) #Anova from the car package

#0Mean two week weather preceding arrival
mc.lmer2 <- lmer(j.day~wk.tmin*wk.tmax*wk.wvec+(1|name),mc.arr.weath2,na.action = "na.fail")

Anova(mc.lmer2) 

mc.arr.aic <- dredge(mc.lmer2,fixed = c("wk.tmin","wk.tmax","wk.wvec"),)

mc.kb <- kable(mc.arr.aic[1:4,],caption = "Fit values for nested models of the most complicated lme model")

kable_styling(mc.kb)

best.lmer <-  lmer(j.day~wk.tmin+wk.tmax+wk.wvec+(1|name),mc.arr.weath2,na.action = "na.fail")

Anova(best.lmer)
```

# Discussion

# References
